/**
 * @file controller.js
 *
 * Interacts with web-server for sending and recieving data.
 *//**
 * Global variable to set value of failed record requests
 * to true/false.
 */function call_animate_save(a,b,c){c?c(b):typeof animate_save!="undefined"&&animate_save(a,b)}function removeReadonlyRanges(a){var b={};return a.forEach(function(a){var c=a.delta.action,d=a.delta.start.row+a.delta.start.column,e=a.delta.end.row+a.delta.end.column,f=a.delta.lines.join(),g=a.timestamp,h=c+d+e+f+g;b[h]={initial_state:{code:a.source},delta:a.delta,timestamp:a.timestamp}}),Object.values(b)}function record_changesets(a,b,c,d,e,f,g){if(!a||!b)return;newChangesets=removeReadonlyRanges(a);var h=get_final_code(a),i={changesets:g?newChangesets:[],final_code:h,last_modified:newChangesets.length?newChangesets[newChangesets.length-1].timestamp:(new Date).getTime()};$(".editor-save-code").html("Saving..."),$.ajax({url:b,type:"POST",retry:c,post_data:i,contentType:"application/json; charset=utf-8",async:d,changesets:a,data:JSON.stringify(i),success:function(a){a.status&&a.status.toLowerCase()==="ok"?(call_animate_save(".editor-save-code",!0,f),g_record_request_failed&&(g_record_request_failed=!1,typeof finish_all_recordings!="undefined"&&finish_all_recordings()),e!=undefined&&typeof e=="function"&&e()):call_animate_save(".editor-save-code",!1,f)},error:function(a){call_animate_save(".editor-save-code",!1,f);if(!this.async)return;if(NOT_ALLOWED_ERROR_CODES.indexOf(a.status)>=0)return;g_record_request_failed=!0,this.retry+=1;var b=this.retry,c=this.async,d=this.changesets,h=this.url,i=function(){return function(){record_changesets(d,h,b,c,e,f,g)}}(d,h,b,c);setTimeout(i,1e4)}})}function setup_timeline(a,b,c){$.ajax({url:"/timeline/api/codevideos/setup/",type:"POST",data:a,dataType:"json",callback:b,callback_arg_obj:c,success:function(a,b,c){this.callback(c.status,a)},error:function(a,b){this.callback(a.status,a.statusText)}})}var g_record_request_failed=!1,NOT_ALLOWED_ERROR_CODES=[500];